"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function generateWrapperCode(e,n){var r=n.collectorURL,t=n.token,a=n.appName,i=n.metadataOnly,s=n.urlsToIgnore,o=n.payloadsToIgnore,c=n.ignoredKeys,u=n.labels,l=(e.epsagon||{}).wrapper,p=void 0===l?DEFAULT_WRAPPERS[e.language]:l,h="python"===e.language?e.relativePath.replace(/\//g,".").replace(/\\/g,"."):e.relativePath,g="object"==typeof u?JSON.stringify(u):u,f="object"==typeof o?JSON.stringify(o):o;return WRAPPER_CODE({relativePath:h,method:e.method,wrapper:p,token:t,appName:a,collectorUrl:r?`'${r}'`:void 0,metadataOnly:!0===i?"1":"0",urlsToIgnore:s,payloadsToIgnore:f,ignoredKeys:c,labels:g})[e.language]}function generateWrapperExt(e){return FILE_NAME_BY_LANG_GENERATORS[e.language](e.epsagonHandler)}var _objectSpread=_interopDefault(require("@babel/runtime/helpers/objectSpread")),_toConsumableArray=_interopDefault(require("@babel/runtime/helpers/toConsumableArray")),_slicedToArray=_interopDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck=_interopDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass=_interopDefault(require("@babel/runtime/helpers/createClass")),_regeneratorRuntime=_interopDefault(require("@babel/runtime/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime/helpers/asyncToGenerator")),fs=_interopDefault(require("fs-extra")),path=require("path"),util=require("util"),_=_interopDefault(require("lodash")),glob=_interopDefault(require("glob-promise")),DEFAULT_WRAPPERS={python:"lambda_wrapper",node:"lambdaWrapper",tsnode:"lambdaWrapper"},WRAPPER_CODE=function(e){var n=e.relativePath,r=e.method,t=e.wrapper,a=e.token,i=e.appName,s=e.collectorUrl,o=e.metadataOnly,c=e.urlsToIgnore,u=e.payloadsToIgnore,l=e.ignoredKeys,p=e.labels,h=`\n  if (!process.env.EPSAGON_IGNORED_KEYS) {\n    process.env.EPSAGON_IGNORED_KEYS = "${l||""}";\n  }\n\n  if (!process.env.EPSAGON_URLS_TO_IGNORE) {\n    process.env.EPSAGON_URLS_TO_IGNORE = "${c||""}";\n  }\n  \n  if (!process.env.EPSAGON_PAYLOADS_TO_IGNORE) {\n    process.env.EPSAGON_PAYLOADS_TO_IGNORE = JSON.stringify(${u} || '');\n  }\n\nepsagon.init({\n    token: '${a}',\n    appName: '${i}',\n    traceCollectorURL: ${s},\n    metadataOnly: Boolean(${o}),\n    labels: ${p||"[]"},\n});`;return{python:`\nfrom ${n} import ${r} as ${r}_internal\n${r} = ${r}_internal\ntry:\n    import epsagon\n    import os\n        \n    ${c?`os.environ['EPSAGON_URLS_TO_IGNORE'] = '${c}' if 'EPSAGON_URLS_TO_IGNORE' not in os.environ else os.environ['EPSAGON_URLS_TO_IGNORE']`:""}\n    ${l?`os.environ['EPSAGON_IGNORED_KEYS'] = '${l}' if 'EPSAGON_IGNORED_KEYS' not in os.environ else os.environ['EPSAGON_IGNORED_KEYS']`:""}\n    ${u?`os.environ['EPSAGON_PAYLOADS_TO_IGNORE'] = '${u}' if 'EPSAGON_PAYLOADS_TO_IGNORE' not in os.environ else os.environ['EPSAGON_PAYLOADS_TO_IGNORE']`:""}\n    \n    null = None  # used to ignore arguments\n    undefined = None  # used to ignore arguments\n    epsagon.init(\n        token='${a}',\n        app_name='${i}',\n        collector_url=${s},\n        metadata_only=bool(${o})\n    )\n\n    ${r} = epsagon.${t}(${r}_internal)\nexcept:\n    print('Warning: Epsagon package not found. The function will not be monitored')\n`,node:`\nconst epsagon = require('epsagon');\nconst epsagonHandler = require('../${n}.js');\n\n${h}\n\nexports.${r} = epsagon.${t}(epsagonHandler.${r});\n`,tsnode:`\nimport * as epsagon from 'epsagon';\nimport * as epsagonHandler from '../${n}';\n\n${h}\n\nexport const ${r} = epsagon.${t}(epsagonHandler.${r});\n`}},FILE_NAME_BY_LANG_GENERATORS={python:function(e){return`${e}.py`},node:function(e){return`${e}.js`},tsnode:function(e){return`${e}.ts`}},SUPPORTED_LANGUAGES=["python","node"],mkdir=fs.mkdirpSync,writeFile=util.promisify(fs.writeFile),VALIDATE_LIB_BY_LANG={python(){this.log("Python functions found, please make sure to install the Epsagon Python library.")},node(){var e=this;return _asyncToGenerator(_regeneratorRuntime.mark(function n(){var r,t,a,i;return _regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,fs.readJson(e.config().packageJsonPath||path.join(e.prefix,"package.json"));case 3:r=n.sent,n.next=10;break;case 6:return n.prev=6,n.t0=n.catch(0),e.log("Could not read package.json. Skipping Epsagon library validation - please make sure you have it installed!"),n.abrupt("return");case 10:if(t=r,a=t.dependencies,i=void 0===a?[]:a,Object.keys(i).some(function(e){return"epsagon"===e})){n.next=13;break}throw new Error("Epsagon's Node library must be installed in order to use this plugin!");case 13:case"end":return n.stop()}},n,null,[[0,6]])}))()}};VALIDATE_LIB_BY_LANG.tsnode=VALIDATE_LIB_BY_LANG.node;var ServerlessEpsagonPlugin=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;if(_classCallCheck(this,e),this.sls=n,this.prefix=r.prefix||this.sls.config.servicePath||process.env.npm_config_prefix,this.funcs=[],this.originalServicePath=this.sls.config.servicePath,this.commands={epsagon:{usage:"Automatically wraps your function handlers with Epsagon.",lifecycleEvents:["run","clean"],commands:{clean:{usage:"Cleans up extra Epsagon files if necessary",lifecycleEvents:["init"]},run:{usage:"Generates epsagon's handlers",lifecycleEvents:["init"]}}}},this.sls.configSchemaHandler){var t={type:"object",properties:{epsagon:{type:"object",properties:{token:{type:"string"},appName:{type:"string"},disable:{type:"boolean"},metadataOnly:{type:"boolean"},handlersDirName:{type:"string"},packageJsonPath:{type:"string"},collectorURL:{type:"string"},ignoredKeys:{type:"string"},urlsToIgnore:{type:"string"},payloadsToIgnore:{type:"array"},labels:{type:"string"},wrapper:{type:"string"}},additionalProperties:!1}}};this.sls.configSchemaHandler.defineCustomProperties(t),this.sls.configSchemaHandler.defineFunctionProperties&&this.sls.configSchemaHandler.defineFunctionProperties("aws",{properties:{epsagon:{type:"object",properties:{appName:{type:"string"},disable:{type:"boolean"},wrapper:{type:"string"}},additionalProperties:!1}}})}this.hooks={"after:package:initialize":this.run.bind(this),"before:deploy:function:packageFunction":this.run.bind(this),"before:invoke:local:invoke":this.run.bind(this),"before:offline:start:init":this.run.bind(this),"before:step-functions-offline:start":this.run.bind(this),"after:package:createDeploymentArtifacts":this.cleanup.bind(this),"after:invoke:local:invoke":this.cleanup.bind(this),"epsagon:clean:init":this.cleanup.bind(this),"epsagon:run:init":this.run.bind(this),"after:deploy:deploy":this.link.bind(this)}}return _createClass(e,[{key:"log",value:function(e){for(var n,r=arguments.length,t=new Array(r>1?r-1:0),a=1;a<r;a++)t[a-1]=arguments[a];(n=this.sls.cli).log.apply(n,[`[serverless-plugin-epsagon] ${e}`].concat(t))}},{key:"link",value:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(_regeneratorRuntime.mark(function e(){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:this.log("Monitor and troubleshoot your functions at [4mhttps://app.epsagon.com/functions[24m");case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"run",value:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(_regeneratorRuntime.mark(function e(){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.config().disable||"true"!==this.config().disable.toString().toLowerCase()){e.next=3;break}return this.log("Epsagon disabled - not wrapping functions"),e.abrupt("return");case 3:if(this.config().token){e.next=6;break}return this.log("No epsagon token was supplied - not wrapping functions"),e.abrupt("return");case 6:return this.log("Wrapping your functions with Epsagon..."),fs.removeSync(path.join(this.originalServicePath,this.config().handlersDirName)),this.funcs=this.findFuncs(),e.next=11,this.handleTS();case 11:return e.next=13,this.validateLib();case 13:return e.next=15,this.generateHandlers();case 15:this.assignHandlers();case 16:case"end":return e.stop()}},e,this)}));return e}()},{key:"validateLib",value:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var n,r=this;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=_.uniq(this.funcs.map(function(e){return e.language})),e.next=3,Promise.all(n.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(n){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,VALIDATE_LIB_BY_LANG[n].bind(r)();case 2:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}},e,this)}));return e}()},{key:"handleTS",value:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(_regeneratorRuntime.mark(function e(){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.funcs.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(n){var r,t,a;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=_.isString(n.handler)?n.handler.split("."):[],t=r.slice(0,-1).join("."),(a=glob.sync(`${t}.*`)).length>0&&(a[0].endsWith(".ts")||a[0].endsWith(".tsx"))&&(n.language="tsnode");case 4:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}},e,this)}));return e}()},{key:"findFuncs",value:function(){var e=this;return Object.entries(this.sls.service.functions).reduce(function(n,r){var t=_slicedToArray(r,2),a=t[0],i=t[1],s=i.runtime||e.sls.service.provider.runtime,o=(i.epsagon||{}).disable,c=_.isString(i.handler)?i.handler.split("."):[],u=c.slice(0,-1).join(".");if(o)return e.log(`Epsagon is disabled for function ${a}, skipping.`),n;if(!_.isString(s))return n;var l=SUPPORTED_LANGUAGES.find(function(e){return s.toLowerCase().match(e)});return l?(n.push(Object.assign(i,{method:_.last(c),key:a,relativePath:u,language:l,epsagonHandler:`${a}-epsagon`})),n):(e.log(`Runtime "${s}" is not supported yet, skipping function ${a}`),n)},[])}},{key:"generateHandlers",value:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var n,r=this;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=path.join(this.originalServicePath,this.config().handlersDirName),e.prev=1,mkdir(n),e.next=9;break;case 5:if(e.prev=5,e.t0=e.catch(1),"EEXIST"===e.t0.code){e.next=9;break}throw e.t0;case 9:return e.next=11,Promise.all(this.funcs.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var a;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r.config().wrapper&&(t.epsagon||(t.epsagon={}),t.epsagon.wrapper=r.config().wrapper),a=generateWrapperCode(t,r.config({funcName:t.key})),e.next=4,writeFile(path.join(n,generateWrapperExt(t)),a);case 4:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}()));case 11:case"end":return e.stop()}},e,this,[[1,5]])}));return e}()},{key:"assignHandlers",value:function(){var e=this;this.funcs.forEach(function(n){var r=`${e.config().handlersDirName.replace("\\","/")}/${n.epsagonHandler}`,t=e.sls.service.functions[n.key];t.handler=`${r}.${n.method}`,_.isObject(t.package)&&_.isObject(t.package.include)&&(t.package.include=[].concat(_toConsumableArray(t.package.include),[r]))}),_.isObject(this.sls.service.package.include)&&(this.sls.service.package.include=[].concat(_toConsumableArray(this.sls.service.package.include),[`${this.config().handlersDirName.replace("\\","/")}/**`]))}},{key:"config",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).funcName,n=void 0===e?"":e,r=((this.sls.service.functions||{})[n]||{}).epsagon||{},t=(this.sls.service.custom||{}).epsagon||{};return _objectSpread({metadataOnly:"false",handlersDirName:"epsagon_handlers"},t,r)}},{key:"cleanup",value:function(){this.log("Cleaning up Epsagon's handlers"),fs.removeSync(path.join(this.originalServicePath,this.config().handlersDirName))}}]),e}();module.exports=ServerlessEpsagonPlugin;
